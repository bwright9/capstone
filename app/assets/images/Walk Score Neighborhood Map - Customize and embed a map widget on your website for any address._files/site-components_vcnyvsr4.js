function TabHeader(e,t){this.walkScoreCore=e,this.geoData=t,this.hoodName=null,this.fromCookie=!0,this.isRankingsCity=!1,this.hoodName=null,this.init=function(){if(this.geoData.getQuery()&&!this.geoData.latLng&&$("#street").val(this.geoData.getQuery()),!$("#your-score").eq(0).html()){this.fromCookie=!1;var e=$("#badge");e.children(".progress").css("display","block"),$("#score-details").css("display","none")}appEvents.addListener("coreGeocode",this.onGeocode,this),appEvents.addListener("coreGeocodeFailed",this.onFailedGeocode,this),appEvents.addListener("scoreCompleted",this.onScoringCompleted,this),appEvents.addListener("isRankingsCityAvailable",this.updateRankingsCity,this),appEvents.addListener("hoodInfoAvailable",this.updateHoodInfo,this),appEvents.addListener("scoreDetails",this.onScoreDetailsReceived,this),this.walkScoreCore.request("isRankingsCity"),this.walkScoreCore.request("hoodInfo"),this.hoodTabChecklist=new Checklist(["hood","rankings"],bindCallback(this,this.updateHoodTab))},this.onGeocode=function(e){this.geoData=e,this.fromCookie||$("#geo-address").html(e.getBestFormattedAddress())},this.onFailedGeocode=function(){showMessage(WS_M_NOT_FOUND,"alert")},this.onScoringCompleted=function(e){if(this.score=e,!this.fromCookie){var t=$("#badge");t.find("#your-score").html(e),t.children(".progress").remove(),t.children("#score-helptext").html("Out of 100").fadeIn(1e3),$("#score-description").html(getScoreDescription(e)),$("#score-details").fadeIn(1e3)}-1==_.indexOf(["US","CA","NZ","AU"],this.geoData.countryCode.toUpperCase())&&this.showScoreAlert("unsupported country")},this.updateRankingsCity=function(e){e&&(this.isRankingsCity=e.isRankingsCity,this.hoodTabChecklist.check("rankings"))},this.updateHoodInfo=function(e){e&&200==e.status&&e.neighborhood&&e.neighborhood.name&&(this.hoodName=e.neighborhood.name),this.hoodTabChecklist.check("hood")},this.updateHoodTab=function(){var e=this.hoodName?this.hoodName:this.geoData.getPostalCode();if(this.isRankingsCity&&e){var t=this.geoData;$("#hoodtab").fadeIn(1e3).click(function(){goToHoodTab(t,e)}).children().html(e),this.hoodCookie=new BasicCookie("hood",getLocationKey(this.geoData)),this.hoodCookie.addData("hoodName",e),this.hoodCookie.save();var a={isHood:null!=this.hoodName,locationName:e};appEvents.fireEvent(null,"hoodOrZipAvailable",[a])}},this.onScoreDetailsReceived=function(e){var t="IE"==this.geoData.countryCode||"UK"==this.geoData.countryCode||"GB"==this.geoData.countryCode;"score-report"==ACTIVE_COMPONENT&&e&&e.scoredetails&&(t||e.scoredetails.is_supported_country===!1?this.showScoreAlert("unsupported country"):"score-report"!=ACTIVE_COMPONENT||e&&e.scoredetails.is_routed!==!1||this.showScoreAlert("street smart unavailable"))},this.showScoreAlert=function(e){if(!this._scoreAlert){if(this._scoreAlert=e,"unsupported country"==e){var t=this.geoData.getCountryName(),a=[];a.push("<h3>Unsupported Country</h3>"),a.push("<p>Walk Score is not yet supported in "+t+". "),a.push("We do not have enough data to ensure an accurate score.</p>")}else if("street smart unavailable"==e){var a=[];a.push("<h3>Street Smart Walk Score Unavailable</h3>"),a.push("<p>The score for this address was calculated using crow-flies distances rather than walking distances. "),a.push("Our map is not accurate enough in this location to calculate walking distances.</p>")}if(a){var i=_(function(e){showDialog(e,"alert",!0,100,100)}).bind({},a.join(""));$("#your-score").append('<div id="score-alert"></div>'),$("#score-alert").click(i),trackEventNonInteractive(ACTIVE_COMPONENT,"show score alert",e)}}}}function CommentsWidget(e,t,a){this.app=e,this.geoData=t,this.locationName=null,this.loaded=!1,appEvents.addListener("hoodOrZipAvailable",this.hoodOrZipAvailable,this),appEvents.addListener("facebookScriptLoaded",this.onFacebookScriptLoaded,this),this.subcats={"Getting Around":["Walking","Biking","Transit","Driving"],Safety:["Crime Safety","Pedestrian Safety","Other"],Places:["Best Places","Public Spaces","Problem Spots","Other"],Schools:["Public Schools","Private Schools","Walking to School","Other"],Community:["People","Pretty or Not","Economy","Noise","Other"],Other:""},this.segments={"Getting Around":"",Safety:"/safety",Places:"/places",Schools:"/schools",Community:"",Other:""};var i=this;$("#comment-cat input[type=radio]").customInput(),$("#comment-cat input").change(function(e){i.setCommentCat($(this).val())});var o="getting-around";a&&(o=a.replace(/\s+/g,"-")),$("#i-"+o).trigger("click").trigger("updateState").trigger("change"),$("#comment-cat input").change(function(e){trackEvent("User Comments","Category Checked",$(this).val())})}function Sharer(e,t){this.geoData=e,this.score=t,this.showShareOptions=function(e,t,a,i){return e=defaultIfNotSet(e,null),t=defaultIfNotSet(t,null),this.showShareScore("all",e-110,t+20,a,i),trackEvent(ACTIVE_COMPONENT,"share score: activate","share your score"),!1},this.showShareScore=function(e,t,a,i,o){if(t=defaultIfNotSet(t,null),a=defaultIfNotSet(a,null),"facebook"==e){var r=window.location.href,s="Check out my Walk Score, then find out your own on WalkScore.com";window.open("http://www.facebook.com/sharer.php?u="+encodeURIComponent(r)+"&t="+encodeURIComponent(s),"sharer","toolbar=0,status=0,width=626,height=436"),hideDialog(),trackEvent(ACTIVE_COMPONENT,"share score: execute","facebook")}else if("twitter"==e){var s="I just got a Walk Score of "+this.score+". What's yours? https://www.walkscore.com";window.open("http://twitter.com/intent/tweet?text="+encodeURIComponent(s)),hideDialog(),trackEvent(ACTIVE_COMPONENT,"share score: execute","twitter")}else if("email"==e)document.location="/tell-a-friend.shtml?score="+this.score+"&url="+escape(window.location.href),trackEvent(ACTIVE_COMPONENT,"share score: execute","email");else if("onyoursite"==e)document.location="/professional/",trackEvent(ACTIVE_COMPONENT,"share score: execute","on your site");else{var n=i?i:"Share Your Walk Score",c=o?o:"Share your score with a friend or add Walk Score to a real estate listing.",l=[];l.push("<h3>"+n+"</h3>"),l.push("<p class='tight-bot'>"+c+"</p>"),l.push("<div class='share-list'>"),l.push("<div class='share-twitter'><span>Twitter</span></div>"),l.push("<div class='share-email'><span>Email</span></div>"),l.push("<div class='share-facebook'><span>Facebook</span></div>"),l.push("<div class='share-onyoursite'><span>On Your Site</span></div>"),l.push("</div>"),showDialog(l.join(""),"share-score",!0,t,a);var d=this;$(".share-twitter").bind("click",function(){d.showShareScore("twitter")}),$(".share-email").bind("click",function(){d.showShareScore("email")}),$(".share-facebook").bind("click",function(){d.showShareScore("facebook")}),$(".share-onyoursite").bind("click",function(){d.showShareScore("onyoursite")})}}}function DataCurator(e,t){this.app=e,this.oidConnector=t,this.activeAmenity=null}function activateAptSearchBox(e){e=e||{};var t=$("#apt-search-input"),a=(new RentalsSearchBox).forceApts().setInput(t);return e.addCommute&&a.addCommute(),_.isArray(e.urlParams)&&a.addUrlParams(e.urlParams),e.inputText&&$("#apt-search-input").val(e.inputText),e.modeButtons&&$(".custom-radio-icons input[type=radio]").customInputIcons(),a}function getFavTweets(e){jQuery.getJSON("/auth/pages/twitter_favorites",function(t){e(t)})}function initFooterTweets(){initTweets({container:"#city-footer .root-container",extraClass:"foot-tweet",nextTweetCallback:function(){for(var e=$("#tweet-0"),t=parseInt(e.css("right")),a=rand(100);Math.abs(a-t)<30;)a+=50;var i=parseInt(e.css("top"))-20,o=rand(35);Math.abs(o-i)<25&&rand(2)&&(o+=25),e.css("top",o+20+"px").css("right",a+"px")},timingTuple:[0,3800,0]})}function initTweets(e){function t(e,t){var a="#tweet-"+t,i=" <span>"+e.datecreated+"</span>",o=$(a);o.find("img").attr("src",e.img),o.find("img").attr("src",e.img),o.find(".text").html(e.text);var r="&mdash;"+e.user+i;o.find(".user a").attr("href","http://twitter.com/"+encodeURIComponent(e.user)).html(r)}function a(e,t){if(e=e.replace(" +0000","")+" +0000",t){var a=/(\w+)/gi,i=e.match(a);e=i[1]+" "+i[2]+", "+i[6]+" "+i[3]+":"+i[4]+":"+i[5]+" +0000"}var o=new Date(e),r=(o.toLocaleString().replace(/  /g," "),["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][o.getMonth()]),s=o.getDate(),n=o.getHours(),c=o.getMinutes()+"";c.length<2&&(c="0"+c);var l=12>n?"am":"pm",d=n%12==0?12:n%12,h=[r,s+",",[d,c].join(":"),l].join(" ");return h}function i(){n||(n="");for(var e="<div id='tweet-wrap'>",t=0;s>t;t++)e+='<div id="tweet-'+t+'" class="tweet '+n+' hidden-phone"><img src="" width="48" height="48" /><div class="quote"><p class="text"></p><p class="user"><a target="_blank"></a></p></div></div>';$(o).append(e),this.tweetWrapDiv=$("#tweet-wrap")}var o=e.container||"#tweets",r=0,s=e.num||1,n=e.extraClass||"",c=e.nextTweetCallback||null,l=e.timingTuple||[800,11e3,500],d=function(e){tweets=[],_(e).each(function(e){tweets.push({text:e.text,user:e.user.screen_name,img:e.user.profile_image_url_https,datecreated:a(e.created_at,!0)})}),h()},h=function(){s=Math.min(s,tweets.length),i(),u(),this.tweetWrapDiv.css("display","block"),m()},u=function(){for(var e=0;s>e;e++)r=(r+1)%tweets.length,t(tweets[r],e)},m=function(){this.tweetWrapDiv.delay(100).fadeIn(l[0]).delay(l[1]).fadeOut(l[2],function(){u(),c&&c()}),setTimeout(m,100+l[0]+l[1]+l[2])};getFavTweets(d)}CommentsWidget.prototype.hoodOrZipAvailable=function(e){e&&e.locationName&&"US"==this.geoData.countryCode&&(this.locationName=e.locationName,this.isHood=e.isHood,$("#neighborhood-comments").css("display","block").children("h2").html("Comment on "+this.locationName),this.updateFBWidget())},CommentsWidget.prototype.setCommentCat=function(e){this.currentCat=e,this.currentSegment!=this.segments[e]&&(this.currentSegment=this.segments[e],this.updateFBWidget());var t="";if("Other"==e)$("#subcat-helptext").html("What category is your comment?"),t+="<input type='text' id='user-other-cat' name='user-other-cat'>";else{$("#subcat-helptext").html("Check the boxes related to your comment:");for(var a in this.subcats[e]){var i=this.subcats[e][a],o=i.replace(/\s+/g,"_");t+="<input type='checkbox' name='subcat' value='"+o+"' /> <label for='"+o+"' >"+i+"</label> &nbsp;&nbsp;&nbsp;"}}$("#subcat-radios").html(t),$("#subcat-radios input").change(function(e){trackEvent("User Comments","Subcategory Checked",$(this).val())})},CommentsWidget.prototype.updateFBWidget=function(){if(this.locationName){this.commentsHref="https://www.walkscore.com"+getHoodUrl(this.geoData,this.locationName)+this.currentSegment;var e='<fb:comments href="'+this.commentsHref+'" num_posts="2" width="475"></fb:comments>';$("#fb-comment-div").html(e),"undefined"!=typeof FB&&FB.XFBML.parse(document.getElementById("fb-comment-div")),window.position_ads&&_(position_ads).thump(500,20)}},CommentsWidget.prototype.onFacebookScriptLoaded=function(){FB.Event.subscribe("comment.create",_(function(e,t){this.recordComment(e.href,e.commentID)}).bind(this)),FB.Event.subscribe("comment.remove",_(function(e){this.deleteComment(e.href,e.commentID)}).bind(this)),this.updateFBWidget()},CommentsWidget.prototype.recordComment=function(e,t){activeComment=t;var a="",i=this.currentCat;"Other"==this.currentCat?(i=$("#user-other-cat").val(),trackEvent("User Comments","Other text",i)):a=_($("#subcat-radios input[type=checkbox]:checked")).map(function(e,t){return e.value.replace(/\_+/g," ")}).join(",");var o={id:t,url:e,category:i,subcategories:a,origin_url:String(document.location.href),lat:this.geoData.preSnapLatLng.lat(),lng:this.geoData.preSnapLatLng.lng(),hood:this.isHood?this.locationName:"",postal:this.geoData.postalCode,city:this.geoData.locality,region:this.geoData.adminArea,country:this.geoData.countryCode};this.create(o),trackEvent("User Comments","Comment Saved",i)},CommentsWidget.prototype.create=function(e){$.ajax({url:"/auth/comments/create",type:"GET",cache:!1,dataType:"json",data:e})},CommentsWidget.prototype.deleteComment=function(){},DataCurator.COMMENT_MAX_LENGTH=500,DataCurator.prototype.initReportListing=function(e,t,a){this.x=t+20,this.y=a-70;var i=[];i.push("<h3>Report Listing</h3>"),i.push('<form name="curate-form" id="curate-form" method="post">'),i.push("<ul>"),i.push('<li class="tight-bot"><label for="rep1"><input type="radio" name="removeType" id="rep1" value="fraudscam"> Fraud or scam.  Remove immediately.</label></li>'),i.push('<li class="tight-bot"><label for="rep2"><input type="radio" name="removeType" id="rep2" value="notavailable"> No longer available</label></li>'),i.push('<li class="tight-bot"><label for="rep3"><input type="radio" name="removeType" id="rep3" value="badinfo"> Incorrect information</label></li>'),i.push('<li class="tight-bot"><label for="rep4"><input type="radio" name="removeType" id="rep4" value="landlordproblem"> Problem with landlord / manager</label></li>'),i.push('<li class="tight-bot"><label for="rep5"><input type="radio" name="removeType" id="rep5" value="other"> Other</label></li>'),i.push('</ul><div class="pad-top"><label>Comments: <span class="extra comments-required" style="display: none;">(required)</span> <span id="char-counter"></span></label><br />'),i.push('<textarea name="comments" id="comments" style="width:95%;" rows="2" ></textarea></div>'),i.push('<div id="user-login"></div>'),i.push('<div><input id="curate-confirm" type="button" value="Report Listing" /> &nbsp; <input id="curate-cancel" type="button" value="Cancel" /></div>'),i.push('<div id="curation-messaging"><p class="tight-bot">&nbsp;</p></div>'),i.push("</form>"),i.push('<div><p class="tight-bot smallfont">If you prefer not to sign in, you can <a id="report-listing-email">report this via email</a>.</p></div>'),i.push('<div><p class="tight-bot smallfont">Protect yourself from rental fraud.  <a href="/apartments/fraud-protection">Learn more</a>.</p></div>'),showDialog(i.join(""),"curate-place",!0,this.x,this.y),this.updateLoginInfo();$("#curate-form").submit(_(this.reportListing).bind(this,e)),$("#curate-confirm").click(_(this.reportListing).bind(this,e)),$("#curate-cancel").click(hideDialog),$("#curate-form").find("input[type=radio]").click(bindCallback(this,this.updateUI)),$("#comments").keyup(function(){limitText($("#comments"),$("#char-counter"),DataCurator.COMMENT_MAX_LENGTH)}),$("#report-listing-email").click(_(function(){var t=$("#curate-form"),a=t.find("textarea").val(),i=t.find("input:radio[name=removeType]:checked").blur().val();return window.open(this.getRentalContactUrl(a,e,i)),!1}).bind(this)),trackEvent("Curation","Show remove dialog",document.location.href)},DataCurator.prototype.reportListing=function(e){var t=$("#curate-form"),a=t.find("textarea").val(),i=t.find("input:radio[name=removeType]:checked").blur().val();if(void 0==i)return void $("#curation-messaging").children().addClass("form-error-message").html("Please select a reason for reporting this listing.");if("other"==i&&0==a.length)return void $("#curation-messaging").children().addClass("form-error-message").html("Please comment on the reason for reporting this.");var o={rid:e,url:""+window.location,reason:i,comment:a};DEBUG_CURATION&&console.log("params",o);var r=function(i){if(DEBUG_CURATION&&console.log("response",i),i&&"OK"==i.result){var o="<h3>Thanks</h3>";o+="<p>We've received your listing report.</p>",o+='<input id="dialog-button" type="button" value="Close" />',updateDialog(o),$("#dialog-button").click(function(){hideDialog(),location.reload()})}else{var r=$.trim(t.find("input:radio[name=removeType]:checked").parent().text()),o="<h3>Oops... Something went wrong</h3>";o+='<p>Please <a href="'+this.getRentalContactUrl(a,e,r)+'">email us</a> to let us know.</p>',o+='<input id="dialog-button" type="button" value="OK" />',updateDialog(o),$("#dialog-button").click(hideDialog)}};$.ajax({url:"/auth/rentals/curate",type:"POST",data:o,dataType:"json",success:_(r).bind(this),error:_(r).bind(this,null)})},DataCurator.prototype.getRentalContactUrl=function(e,t,a){var i="/contact-us.php?m=report_listing&message=";return i+=encodeURIComponent("Comment:<br>"+e+"<br><br><br>----------------------------------------<br>"),i+=encodeURIComponent("Report Listing Details:<br>URL: "+window.location+"<br>Listing ID: "+t+"<br>Reason: "+(a||""))},DataCurator.prototype.initRemovePlace=function(e,t,a){this.x=t+20,this.y=a-70;var i=[];i.push("<h3>Report This Place?</h3>"),_(["Curated","Google","Local"]).include(e.getDataSource())&&i.push('<a class="edit-place-link">Edit place details</a>'),i.push('<form name="curate-form" id="curate-form" method="post">'),i.push('<p class="pad-top tight-bot">Reason for reporting '+e.getName()+":</p>"),i.push("<ul>"),i.push('<li class="tight-bot"><label for="rem1"><input type="radio" name="removeType" id="rem1" value="closed or not exist"> Closed or doesn\'t exist</label></li>'),i.push('<li class="tight-bot"><label for="rem2"><input type="radio" name="removeType" id="rem2" value="wrong category"> Doesn\'t belong in '+e.getCategory()+"</label></li>"),i.push('<li class="tight-bot"><label for="rem3"><input type="radio" name="removeType" id="rem3" value="duplicate"> Duplicate listing</label></li>'),i.push('<li><label for="rem4"><input type="radio" name="removeType" id="rem4" value="other"> Other</label></li>'),i.push('</ul><div class="pad-top"><label>Comments: <span class="extra comments-required" style="display: none;">(required)</span> <span id="char-counter"></span></label><br />'),i.push('<textarea name="comments" id="comments" style="width:95%;" rows="2" ></textarea></div>'),i.push('<div id="user-login"></div>'),i.push('<div><input id="curate-confirm" type="button" value="Report Place" /> &nbsp; <input id="curate-cancel" type="button" value="Cancel" /></div>'),i.push('<div id="curation-messaging"><p class="tight-bot">&nbsp;</p></div>'),i.push("</form>"),showDialog(i.join(""),"curate-place",!0,this.x,this.y),this.updateLoginInfo(),this.activeAmenity=e;var o=this;$("#curate-form").submit(function(){o.saveRemovedPlace()}),$("#curate-confirm").click(bindCallback(this,this.saveRemovedPlace)),$("#curate-cancel").click(hideDialog),$("#curate-form").find("input[type=radio]").click(bindCallback(this,this.updateUI)),$("#comments").keyup(function(){limitText($("#comments"),$("#char-counter"),DataCurator.COMMENT_MAX_LENGTH)}),$(".edit-place-link").click(_(function(){return hideDialog(),_(["Curated","Local"]).include(e.getDataSource())?this.app.showEditAmenityDialog(e,t,a):"Google"==e.getDataSource()&&window.open(e.getUrl()+"&mode=edit","edit"),!1}).bind(this)),trackEvent("Curation","Show remove dialog",document.location.href)},DataCurator.prototype.saveRemovedPlace=function(){trackEvent(ACTIVE_COMPONENT,"place review completed","flag");var e=$("#curate-form"),t=e.find("textarea").val(),a=e.find("input:radio[name=removeType]:checked").blur().val();if(void 0==a)return void $("#curation-messaging").children().addClass("form-error-message").html("Please select a reason for removing.");if("other"==a&&0==t.length)return void $("#curation-messaging").children().addClass("form-error-message").html("Please comment on the reason for removing this place.");DEBUG_CURATION&&dbug("saving removed place: "+this.activeAmenity.getName());var i=this.activeAmenity.getKey();if(isUserAddedAmenity(i)&&!this.activeAmenity.local_source)this.deleteAmenity();else{var o=this.activeAmenity.local_source;o&&(this.deleteAmenity(!0),this.activeAmenity=o,o.key=generateAmenityKey(o.name,o.point,"Local"),i=o.getKey());var r="";r+=urlifyParam("act","remove"),r+=urlifyParam("&key",i),r+=urlifyParam("&lat",this.activeAmenity.getPoint().lat()),r+=urlifyParam("&lng",this.activeAmenity.getPoint().lng()),r+=urlifyParam("&reason",a),r+=urlifyParam("&comment",t),r+=urlifyParam("&cat",this.activeAmenity.getCategory()),r+=urlifyParam("&ws_url",document.location.href);var s=this;this.submitData(r,function(e){s.onRemoveComplete(parseJson(e))}),$("#curate-confirm").attr("disabled",!0),$("#curation-messaging").children().removeClass("form-error-message").addClass("progress").html("Saving your change...")}},DataCurator.prototype.onRemoveComplete=function(e){e&&"success"==e.report?(this.app.removeAmenities([this.activeAmenity.getKey()]),this.showCuratePlaceThanks(),trackEvent("Curation","Remove amenity",document.location.href),this.activeAmenity=null):($("#curation-messaging").children().removeClass("progress").addClass("form-error-message").html("Couldn't save your change, try reloading this page."),$("#curate-confirm").attr("disabled",!1))},DataCurator.prototype.showCuratePlaceThanks=function(){var e=[];e.push("<h3>Thank You!</h3>"),e.push("<p>We've updated the listing for "+this.activeAmenity.getName()+".</p>"),e.push('<p><a id="curate-thanks-close">Close this window</a></p>'),showDialog(e.join(""),"curate-place",!0,this.x,this.y),$("#curate-thanks-close").click(hideDialog)},DataCurator.prototype.initRestorePlace=function(e,t,a){this.x=t+20,this.y=a-70;var i=[];i.push("<h3>Restore This Place</h3>"),i.push('<form name="curate-form" id="curate-form" method="post">'),i.push("<p>"+e.getName()+" was removed by a Walk Score user.</p>"),i.push("<p>Click the button below to restore it.</p>"),i.push('<div><label>Comments:</label> <span id="char-counter"></span></label><br />'),i.push('<textarea name="comments" id="comments" style="width:90%;" rows="3" ></textarea></div>'),i.push('<div id="user-login"></div>'),i.push('<div><input id="curate-confirm" type="button" value="Restore Place" /> &nbsp; <input id="curate-cancel" type="button" value="Cancel" /></div>'),i.push('<div id="curation-messaging"><p class="tight-bot"></p></div>'),i.push("</form>"),showDialog(i.join(""),"curate-place",!0,this.x,this.y),this.updateLoginInfo(),this.activeAmenity=e;$("#curate-form").submit(bindCallback(this,this.saveRestoredPlace)),$("#curate-confirm").click(bindCallback(this,this.saveRestoredPlace)),$("#curate-cancel").click(hideDialog),$("#comments").keyup(function(){limitText($("#comments"),$("#char-counter"),DataCurator.COMMENT_MAX_LENGTH)}),trackEvent("Curation","Show restore dialog",document.location.href)},DataCurator.prototype.saveRestoredPlace=function(){var e=$("#curate-form"),t=(e.find("textarea").val(),"");t+=urlifyParam("act","restore"),t+=urlifyParam("&key",this.activeAmenity.getKey()),t+=urlifyParam("&comment",e.find("textarea").val()),t+=urlifyParam("&cat",this.activeAmenity.getCategory()),t+=urlifyParam("&ws_url",document.location.href);var a=this;this.submitData(t,function(e){a.onRestoreComplete(parseJson(e))}),$("#curate-confirm").attr("disabled",!0),$("#curation-messaging").children().removeClass("form-error-message").addClass("progress").html("Saving your change...")},DataCurator.prototype.onRestoreComplete=function(e){e&&"success"==e.report?(hideDialog(),this.app.restoreAmenity(this.activeAmenity),trackEvent("Curation","Restore amenity",document.location.href),this.activeAmenity=null):($("#curation-messaging").children().removeClass("progress").addClass("form-error-message").html("Couldn't save your change, try reloading this page."),$("#curate-confirm").attr("disabled",!1))},DataCurator.prototype.initEditPlace=function(e,t,a,i,o){this.activeAmenity=e,this.showAddOrEditPlace("Edit",t,e.getCategory(),a,i,o),trackEvent("Curation","Show edit dialog",document.location.href)},DataCurator.prototype.initAddPlace=function(e,t,a,i,o){this.activeAmenity=null,this.showAddOrEditPlace("Add",e,t,a,i,o),trackEvent("Curation","Show add dialog",document.location.href)},DataCurator.prototype.showAddOrEditPlace=function(e,t,a,i,o,r){this.geocoder=i,this.x=o+20,this.y=r-70;var s=[];s.push("<h3>"+e+" a Place</h3>"),s.push('<form name="curate-form" id="curate-form" method="post">'),s.push("<p><label>What type of place?</label><br />"),s.push('<select name="category">'),function(){var e={},i=0;_(t.list).chain().map(function(t){return _(t.includes||[]).each(function(a){e[a.getName()]=t.getName()}),t}).map(function(t){var a=t.getName(),i=e[a];return[i||a,i?t.getShortName():t.includes?"Other":null,a]}).sort(function(e,t){return e[0]<t[0]?-1:e[0]>t[0]?1:"Other"==t[1]?-1:"Other"==e[1]?1:e[1]<t[1]?-1:e[1]>t[1]?1:0}).map(function(e){return[e[1]?e[0]+": "+e[1]:e[0],e[2],e[0]]}).each(function(e){s.push('<option value="'+e[1]+'"'+(e[2]!=a||i++?"":" selected")+">"+e[0]+"</option>")})}(),s.push("</select></p>"),s.push('<div id="add-map"></div>'),s.push('<div class="vertical-spaced-form">'),s.push("<div><label>Place Name <span>e.g. Irwin's Coffee Shop</span></label><br />"),s.push('<input name="placename" type="text"></input></div>'),s.push("<div><label>Address <span>e.g. 2123 N 40th St. Seattle, WA 98103</span></label><br />"),s.push('<input name="address" id="add-address" type="text"></input></div>'),s.push("<div><label>Phone Number <span>e.g. (206)555-5555</span></label><br />"),s.push('<input name="phone" type="text"></input></div>'),s.push("<div><label>Website <span>e.g. www.irwins.com</span></label><br />"),s.push('<input name="site" type="text"></input></div>'),s.push('<div><label>Comments:</label><br /> <span id="char-counter"></span>'),s.push('<textarea name="comments" id="comments"></textarea></div>'),s.push("</div>"),s.push('<div id="user-login"></div>'),s.push('<div><input id="curate-confirm" type="button" value="Submit" /> &nbsp; <input id="curate-cancel" type="button" value="Cancel" /></div>'),s.push('<div id="curation-messaging"><p class="tight-bot"></p></div>'),s.push("</form>"),showDialog(s.join(""),"add-place",!0,this.x,this.y),this.updateLoginInfo();var n=have_google?{mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:!1,streetViewControl:!1,scrollwheel:!1,panControl:!1,zoomControl:!1}:{},c=have_google?{}:{mapTypeId:Microsoft.Maps.MapTypeId.road,showDashboard:!1};this.geoData=new GeoData(void 0,new ws.LatLng(-7,-95)),this.map=new AmenityMap(this),this.map.init($("#add-map"),this.geoData,{autoShowTransit:!1,zoom:0,bingOptions:c,gmapOptions:n});var l=have_google?"mod_google_map":"mod_bing_map";this.map.enableModule(l),this.map.finalizeModules(),this.map.activateModule(l);if($("#curate-form").submit(bindCallback(this,this.saveAddedPlace)),$("#curate-confirm").click(bindCallback(this,this.saveAddedPlace)),$("#curate-cancel").click(hideDialog),$("#add-address").change(bindCallback(this,this.geocodeAddAddress)),$("#comments").keyup(function(){limitText($("#comments"),$("#char-counter"),DataCurator.COMMENT_MAX_LENGTH)}),this.activeAmenity){var d=this.activeAmenity,h=$("#curate-form");"Local"!=d.getDataSource()||d.userAddress||(d.userAddress=_(["getStreetAddress","getCity","getRegion"]).map(function(e){return d[e]()}).join(" ")),_({category:a,placename:reversespecialchars(d.getName()),address:d.userAddress,phone:reversespecialchars(d.getPhoneNumber()),site:reversespecialchars(d.getUrl())}).each(function(e,t){h.find("[name="+t+"]").val(e)}),this.geocodeAddAddress()}},DataCurator.prototype.geocodeAddAddress=function(){var e=$("#add-address").val(),t=new GeoData(e);this.geocoder.autoFillPartialGeoData(t,bindCallback(this,this.showGeocodeLocation))},DataCurator.prototype.showGeocodeLocation=function(e){this.addPlaceMarker&&this.map.mod_do("removeOverlay")(this.addPlaceMarker),this.icon||(this.icon=(new IconFactory).makeBuildingIcon()),e&&e.hasData()?(this.addGeoData=e,$("#curation-messaging").children().html(""),this.addPlaceMarker=new ws.Marker({position:e.getPreSnapLatLng(),icon:this.icon}),this.map.mod_do("addOverlay")(this.addPlaceMarker),this.map.mod_do("goTo")(e.getPreSnapLatLng(),AmenityMap.DEFAULT_ZOOM)):$("#curation-messaging").children().addClass("form-error-message").html("Couldn't locate this address -- please try again.")},DataCurator.prototype.saveAddedPlace=function(){var e=$("#curate-form"),t=e.find("[name=category]").val(),a=e.find("[name=placename]").val(),i=e.find("[name=address]").val(),o=e.find("[name=phone]").val(),r=e.find("[name=site]").val(),s=e.find("textarea").val(),n=r.indexOf("://");if((r.length>0&&-1==n||n>8)&&(r="http://"+r),a)if(i&&this.addGeoData&&this.addGeoData.hasData())if(r.length>0&&!isValidUrl(r))$("#curation-messaging").children().addClass("form-error-message").html("Please correct the website address, or leave it blank.");else{var c=this.addGeoData.getPreSnapLatLng(),l=generateAmenityKey(a,c,"Curated"),d=c.lat(),h=c.lng(),u=this.addGeoData.getThoroughfare(),m=this.addGeoData.getCity(),p=this.addGeoData.getAdminArea(),g=this.addGeoData.getPostalCode();this.activeAmenity&&("Local"==this.activeAmenity.getDataSource()&&(this.activeAmenity.key="ws_local_"+this.activeAmenity.pid),l=this.activeAmenity.key);var v="";v+=urlifyParam("key",l),v+=urlifyParam("&cat",t),v+=urlifyParam("&name",a),v+=urlifyParam("&user_address",i),v+=urlifyParam("&address",u),v+=urlifyParam("&city",m),v+=urlifyParam("&region",p),v+=urlifyParam("&postal",g),v+=urlifyParam("&lat",d),v+=urlifyParam("&lng",h),v+=urlifyParam("&phone",o),v+=urlifyParam("&url",r),v+=urlifyParam("&ws_url",document.location.href),v+=urlifyParam("&comment",s);var f=this,y={category:t,key:l,pid:this.activeAmenity?this.activeAmenity.pid:"",lat:d,lng:h,url:r,name:a,user_address:i,address:u,city:m,region:p,postal:g,phone:o};this.activeAmenity&&"Local"!=this.activeAmenity.getDataSource()?(v+=urlifyParam("&act","edit"),v+=urlifyParam("&old_key",this.activeAmenity.getKey()),v+=urlifyParam("&old_cat",this.activeAmenity.getCategory())):v+=urlifyParam("&act","add"),this.submitData(v,function(e){f.onAdditionComplete(parseJson(e),y)}),$("#curate-confirm").attr("disabled",!0),$("#curation-messaging").children().removeClass("form-error-message").addClass("progress").html("Saving your change...")}else $("#curation-messaging").children().addClass("form-error-message").html("Couldn't locate this address -- please try again.");else $("#curation-messaging").children().addClass("form-error-message").html("Please enter the name of the place to add.")},DataCurator.prototype.onAdditionComplete=function(e,t){if(e&&"success"==e.report)if(hideDialog(),this.activeAmenity)"Local"==this.activeAmenity.getDataSource()&&(t.local_source=this.activeAmenity),this.app.updateResult(t,"Curated",this.activeAmenity),trackEvent("Curation","Edit amenity",document.location.href),this.activeAmenity=null;else{this.app.addNewResult(t,"Curated");trackEvent("Curation","Add amenity",document.location.href)}else message=(e||{}).error?e.error:"Couldn't save your change, try reloading this page.",$("#curation-messaging").children().removeClass("progress").addClass("form-error-message").html(message),$("#curate-confirm").attr("disabled",!1)},DataCurator.prototype.deleteAmenity=function(e){var t="";t+=urlifyParam("act","delete"),t+=urlifyParam("&key",this.activeAmenity.getKey()),t+=urlifyParam("&cat",this.activeAmenity.getCategory()),t+=urlifyParam("&ws_url",document.location.href);var a=this;this.submitData(t,function(t){e||a.onDeleteComplete(parseJson(t))}),e&&this.app.deleteAmenity(this.activeAmenity.getCategory(),this.activeAmenity.getKey()),$("#curate-confirm").attr("disabled",!0),$("#curation-messaging").children().removeClass("form-error-message").addClass("progress").html("Saving your change...")},DataCurator.prototype.onDeleteComplete=function(e){e&&"success"==e.report?(hideDialog(),this.app.deleteAmenity(this.activeAmenity.getCategory(),this.activeAmenity.getKey()),trackEvent("Curation","Remove amenity",document.location.href),this.activeAmenity=null):($("#curation-messaging").children().removeClass("progress").addClass("form-error-message").html("Couldn't save your change, try reloading this page."),$("#curate-confirm").attr("disabled",!1))},DataCuratorAuthMixin(DataCurator.prototype),DataCurator.prototype.updateUI=function(){if($("#curate-form").length){var e="other"==$("#curate-form").find("input:radio[name=removeType]:checked").blur().val();$(".comments-required").css("display",e?"inline":"none")}},DataCurator.prototype.submitData=function(e,t){$.ajax({url:"/data/curate.php",type:"POST",data:e,success:t,error:t})};